{"version":3,"sources":["../../../../../../packages/vite/src/executors/dev-server/dev-server.impl.ts"],"sourcesContent":["import 'dotenv/config';\nimport { ExecutorContext } from '@nx/devkit';\nimport { createServer, InlineConfig, mergeConfig, ViteDevServer } from 'vite';\n\nimport {\n  getViteSharedConfig,\n  getNxTargetOptions,\n  getViteServerOptions,\n  getViteBuildOptions,\n} from '../../utils/options-utils';\n\nimport { ViteDevServerExecutorOptions } from './schema';\nimport { ViteBuildExecutorOptions } from '../build/schema';\nimport { registerTsConfigPaths } from '@nx/js/src/internal';\nimport { resolve } from 'path';\n\nexport async function* viteDevServerExecutor(\n  options: ViteDevServerExecutorOptions,\n  context: ExecutorContext\n): AsyncGenerator<{ success: boolean; baseUrl: string }> {\n  const projectRoot =\n    context.projectsConfigurations.projects[context.projectName].root;\n\n  registerTsConfigPaths(resolve(projectRoot, 'tsconfig.json'));\n\n  // Retrieve the option for the configured buildTarget.\n  const buildTargetOptions: ViteBuildExecutorOptions = getNxTargetOptions(\n    options.buildTarget,\n    context\n  );\n\n  // Merge the options from the build and dev-serve targets.\n  // The latter takes precedence.\n  const mergedOptions = {\n    ...buildTargetOptions,\n    ...options,\n  };\n\n  // Add the server specific configuration.\n  const serverConfig: InlineConfig = mergeConfig(\n    getViteSharedConfig(mergedOptions, options.clearScreen, context),\n    {\n      build: getViteBuildOptions(mergedOptions, context),\n      server: getViteServerOptions(mergedOptions, context),\n    }\n  );\n\n  try {\n    const server = await createServer(serverConfig);\n    await runViteDevServer(server);\n    const resolvedUrls = [\n      ...server.resolvedUrls.local,\n      ...server.resolvedUrls.network,\n    ];\n\n    yield {\n      success: true,\n      baseUrl: resolvedUrls[0] ?? '',\n    };\n  } catch (e) {\n    console.error(e);\n    yield {\n      success: false,\n      baseUrl: '',\n    };\n  }\n\n  await new Promise<void>((resolve) => {\n    process.once('SIGINT', () => resolve());\n    process.once('SIGTERM', () => resolve());\n    process.once('exit', () => resolve());\n  });\n}\n\nasync function runViteDevServer(server: ViteDevServer): Promise<void> {\n  await server.listen();\n  server.printUrls();\n\n  const processOnExit = async () => {\n    await server.close();\n  };\n\n  process.once('SIGINT', processOnExit);\n  process.once('SIGTERM', processOnExit);\n  process.once('exit', processOnExit);\n}\n\nexport default viteDevServerExecutor;\n"],"names":["viteDevServerExecutor","options","context","projectRoot","projectsConfigurations","projects","projectName","root","registerTsConfigPaths","resolve","buildTargetOptions","getNxTargetOptions","buildTarget","mergedOptions","serverConfig","mergeConfig","getViteSharedConfig","clearScreen","build","getViteBuildOptions","server","getViteServerOptions","createServer","runViteDevServer","resolvedUrls","local","network","success","baseUrl","e","console","error","Promise","process","once","listen","printUrls","processOnExit","close"],"mappings":";;;;;;;;IAgBuBA,qBAAqB;eAArBA;;IAuEvB,OAAqC;eAArC;;;;QAvFO;sBAEgE;8BAOhE;0BAI+B;sBACd;AAEjB,gBAAgBA,sBACrBC,OAAqC,EACrCC,OAAwB,EAC+B;IACvD,MAAMC,cACJD,QAAQE,sBAAsB,CAACC,QAAQ,CAACH,QAAQI,WAAW,CAAC,CAACC,IAAI;IAEnEC,IAAAA,+BAAqB,EAACC,IAAAA,aAAO,EAACN,aAAa;IAE3C,sDAAsD;IACtD,MAAMO,qBAA+CC,IAAAA,gCAAkB,EACrEV,QAAQW,WAAW,EACnBV;IAGF,0DAA0D;IAC1D,+BAA+B;IAC/B,MAAMW,gBAAgB,eACjBH,oBACAT;IAGL,yCAAyC;IACzC,MAAMa,eAA6BC,IAAAA,iBAAW,EAC5CC,IAAAA,iCAAmB,EAACH,eAAeZ,QAAQgB,WAAW,EAAEf,UACxD;QACEgB,OAAOC,IAAAA,iCAAmB,EAACN,eAAeX;QAC1CkB,QAAQC,IAAAA,kCAAoB,EAACR,eAAeX;IAC9C;IAGF,IAAI;QACF,MAAMkB,SAAS,MAAME,IAAAA,kBAAY,EAACR;QAClC,MAAMS,iBAAiBH;QACvB,MAAMI,eAAe;eAChBJ,OAAOI,YAAY,CAACC,KAAK;eACzBL,OAAOI,YAAY,CAACE,OAAO;SAC/B;YAIUF;QAFX,MAAM;YACJG,SAAS,IAAI;YACbC,SAASJ,CAAAA,iBAAAA,YAAY,CAAC,EAAE,YAAfA,iBAAmB,EAAE;QAChC;IACF,EAAE,OAAOK,GAAG;QACVC,QAAQC,KAAK,CAACF;QACd,MAAM;YACJF,SAAS,KAAK;YACdC,SAAS;QACX;IACF;IAEA,MAAM,IAAII,QAAc,CAACvB,UAAY;QACnCwB,QAAQC,IAAI,CAAC,UAAU,IAAMzB;QAC7BwB,QAAQC,IAAI,CAAC,WAAW,IAAMzB;QAC9BwB,QAAQC,IAAI,CAAC,QAAQ,IAAMzB;IAC7B;AACF;AAEA,eAAec,iBAAiBH,MAAqB,EAAiB;IACpE,MAAMA,OAAOe,MAAM;IACnBf,OAAOgB,SAAS;IAEhB,MAAMC,gBAAgB,UAAY;QAChC,MAAMjB,OAAOkB,KAAK;IACpB;IAEAL,QAAQC,IAAI,CAAC,UAAUG;IACvBJ,QAAQC,IAAI,CAAC,WAAWG;IACxBJ,QAAQC,IAAI,CAAC,QAAQG;AACvB;MAEA,WAAerC"}